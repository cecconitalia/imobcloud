{% load static %}
{% load pdf_filters %}

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Termo de Visita - #{{ visita.id }}</title>
    <style>
        @page {
            size: A4;
            margin: 1.5cm;
            margin-top: 5.5cm; 
            margin-bottom: 2.0cm; 

            /* FRAME DE CABEÇALHO */
            @frame header_frame {
                -pdf-frame-content: header_content;
                left: 1.5cm; 
                width: 18cm; 
                top: 0.5cm; 
                height: 4.5cm; 
            }
            
            /* FRAME DE RODAPÉ */
            @frame footer_frame {
                -pdf-frame-content: footer_content;
                left: 1.5cm; 
                width: 18cm; 
                top: 28cm; 
                height: 1cm;
            }
        }
        
        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 10pt;
            color: #000;
            line-height: 1.3;
        }

        /* Classes Utilitárias */
        .w-100 { width: 100%; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-bold { font-weight: bold; }
        .uppercase { text-transform: uppercase; }
        
        /* Tabelas */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        td, th {
            padding: 3px;
            vertical-align: top;
        }
        
        /* Tabelas de Dados */
        .data-table td {
            border-bottom: 1px solid #ddd;
        }
        .data-table .label {
            background-color: #f8f9fa;
            width: 130px;
            font-weight: bold;
            color: #444;
        }

        /* Cabeçalho Rico */
        .header-container {
            border-bottom: 2px solid #333;
            padding-bottom: 5px;
        }
        .logo-img {
            max-height: 60px;
            width: auto;
            margin-bottom: 5px;
        }
        .company-name {
            font-size: 14pt;
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 2px;
        }
        .company-info {
            font-size: 8pt;
            color: #333;
            line-height: 1.2;
        }
        .doc-title {
            font-size: 14pt;
            font-weight: bold;
            color: #333;
            text-transform: uppercase;
        }

        /* Seções */
        .section-header {
            background-color: #eee;
            color: #000;
            font-size: 11pt;
            font-weight: bold;
            padding: 5px;
            border: 1px solid #ccc;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        /* Itens e Jurídico */
        .imovel-item { margin-bottom: 10px; page-break-inside: avoid; }
        .imovel-counter {
            font-size: 9pt; font-weight: bold; color: #0056b3;
            border-bottom: 1px dashed #ccc; margin-bottom: 2px;
        }
        .legal-text {
            font-size: 9pt; text-align: justify; line-height: 1.3;
            margin-top: 5px; border: 1px solid #000; padding: 8px;
        }
        .legal-clause { margin-bottom: 6px; display: block; }

        /* Assinaturas */
        .signatures-wrapper { margin-top: 20px; page-break-inside: avoid; }
        .signature-box {
            height: 70px; margin-bottom: 5px;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .signature-img { max-height: 60px; width: auto; }
        .signature-line {
            border-top: 1px solid #000; margin: 0 10px; padding-top: 5px;
            font-weight: bold; font-size: 9pt;
        }
    </style>
</head>
<body>

    <div id="header_content">
        <table class="header-container">
            <tr>
                <td width="65%" style="vertical-align: top;">
                    {% with empresa=imobiliaria %}
                    
                        {% if empresa.foto_perfil %}
                            <img src="{{ empresa.foto_perfil|absolute_path }}" class="logo-img">
                            <br>
                        {% endif %}
                        
                        <div class="company-name">{{ empresa.nome|default:"ImobHome" }}</div>
                        
                        <div class="company-info">
                            {% if empresa.razao_social and empresa.razao_social != empresa.nome %}
                                {{ empresa.razao_social }}<br>
                            {% endif %}
                            
                            <strong>CNPJ:</strong> {{ empresa.cnpj|default:"-" }} &nbsp;|&nbsp; <strong>CRECI:</strong> {{ empresa.creci|default:"-" }}
                            <br>
                            
                            {{ empresa.logradouro|default:"" }}, {{ empresa.numero|default:"" }} 
                            {% if empresa.bairro %} - {{ empresa.bairro }}{% endif %}
                            <br>
                            {{ empresa.cidade|default:"" }} - {{ empresa.estado|default:"" }}
                            {% if empresa.cep %} (CEP: {{ empresa.cep }}){% endif %}
                            <br>
                            
                            <strong>Tel:</strong> {{ empresa.telefone|default:"-" }}
                            {% if empresa.email %} | <strong>Email:</strong> {{ empresa.email }}{% endif %}
                        </div>
                    {% endwith %}
                </td>

                <td width="35%" class="text-right" style="vertical-align: top;">
                    <div class="doc-title" style="margin-top: 10px;">TERMO DE VISITA</div>
                    <div style="font-size: 10pt; margin-top: 5px;">PROTOCOLO: <strong style="color: #d9534f;">#{{ visita.id }}</strong></div>
                    <div style="font-size: 9pt; color: #555; margin-top: 5px;">
                        <strong>{{ visita.data_agendamento|date:"d/m/Y" }} - {{ visita.data_agendamento|time:"H:i" }}</strong>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <div id="footer_content">
        <div class="text-center" style="font-size: 8pt; border-top: 1px solid #ccc; padding-top: 5px; color: #666;">
            Sistema ImobHome - Documento oficial gerado em {% now "d/m/Y H:i" %} - Pág. <pdf:pagenumber> de <pdf:pagecount>
        </div>
    </div>

    <div class="section-header">1. IMÓVEL(IS) APRESENTADO(S)</div>
    
    {% for imovel in visita.imoveis.all %}
    <div class="imovel-item">
        <div class="imovel-counter">Ref: {{ imovel.codigo|default:"-" }}</div>
        <table class="data-table">
            <tr>
                <td class="label">Código:</td>
                <td><strong>{{ imovel.codigo|default:"-" }}</strong></td>
                <td class="label">Tipo:</td>
                <td>{{ imovel.get_tipo_display|default:imovel.tipo|default:"Imóvel" }}</td>
            </tr>
            <tr>
                <td class="label">Endereço:</td>
                <td colspan="3">
                    {{ imovel.logradouro|default:"" }}, Nº {{ imovel.numero|default:"S/N" }}
                    {% if imovel.complemento %} - {{ imovel.complemento }} {% endif %}
                </td>
            </tr>
            <tr>
                <td class="label">Bairro/Cidade:</td>
                <td colspan="3">
                    {{ imovel.bairro|default:"" }} - {{ imovel.cidade|default:"" }} / {{ imovel.estado|default:"" }}
                </td>
            </tr>
            <tr>
                <td class="label">Finalidade:</td>
                <td class="uppercase">{{ imovel.get_finalidade_display|default:"Venda/Aluguel" }}</td>
                <td class="label">CEP:</td>
                <td>{{ imovel.cep|default:"-" }}</td>
            </tr>
        </table>
    </div>
    {% empty %}
    <div style="padding: 20px; text-align: center; color: #999; border: 1px dashed #ccc;">
        Nenhum imóvel vinculado a esta visita.
    </div>
    {% endfor %}

    <div class="section-header">2. PARTICIPANTES</div>
    <table class="data-table">
        <tr>
            <td class="label">Cliente (Visitante):</td>
            <td>
                <strong>{{ visita.cliente.nome }}</strong>
                <br>
                <span style="font-size: 9pt;">
                    Doc/CPF: {{ visita.cliente.documento|default:"Não informado" }}
                    {% if visita.cliente.telefone %} | Tel: {{ visita.cliente.telefone }} {% endif %}
                </span>
            </td>
        </tr>
        <tr>
            <td class="label">Corretor Responsável:</td>
            <td>
                <strong>{{ visita.corretor.get_full_name|default:visita.corretor.username }}</strong>
                <br>
                <span style="font-size: 9pt;">
                    CRECI: {{ visita.corretor.perfil.creci|default:"Não informado" }} | Email: {{ visita.corretor.email }}
                </span>
            </td>
        </tr>
    </table>

    <div class="section-header">3. DECLARAÇÃO E RECONHECIMENTO DE HONORÁRIOS</div>
    <div class="legal-text">
        <span class="legal-clause">
            1. Pelo presente instrumento, o(a) <strong>CLIENTE/VISITANTE</strong> acima identificado(a) declara, para todos os fins de direito, que visitou nesta data o(s) imóvel(is) descrito(s) no Item 1, por intermédio e apresentação exclusiva do <strong>CORRETOR</strong> e da <strong>IMOBILIÁRIA</strong> identificados neste documento.
        </span>
        <span class="legal-clause">
            2. O(A) CLIENTE declara que não conhecia o(s) referido(s) imóvel(is) e que não o(s) visitou anteriormente através de outro profissional ou diretamente com o proprietário.
        </span>
        <span class="legal-clause">
            3. O(A) CLIENTE reconhece que o trabalho de aproximação e mediação foi iniciado nesta data pela IMOBILIÁRIA. Desta forma, compromete-se a não realizar qualquer negociação (Compra, Venda ou Locação) do(s) imóvel(is) listado(s) diretamente com o proprietário ou por meio de terceiros, sem a devida participação e remuneração da IMOBILIÁRIA citada, respeitando o disposto nos artigos 722 a 729 do Código Civil Brasileiro.
        </span>
        <span class="legal-clause">
            4. Este termo tem validade jurídica de comprovação de apresentação e servirá como prova para cobrança de honorários de corretagem caso a negociação venha a ser concretizada à revelia do Corretor responsável.
        </span>
    </div>

    <div class="signatures-wrapper">
        <table class="w-100 text-center">
            <tr>
                <td width="50%">
                    <div class="signature-box">
                        {% if visita.assinatura_cliente %}
                            <img src="{{ visita.assinatura_cliente|absolute_path }}" class="signature-img">
                        {% else %}
                            <div style="height:50px;"></div>
                        {% endif %}
                    </div>
                    <div class="signature-line">{{ visita.cliente.nome }}</div>
                    <div style="font-size: 8pt;">Cliente / Visitante</div>
                </td>
                <td width="50%">
                    <div class="signature-box">
                        {% if visita.assinatura_corretor %}
                            <img src="{{ visita.assinatura_corretor|absolute_path }}" class="signature-img">
                        {% elif visita.corretor.perfil.assinatura_digital %}
                            <img src="{{ visita.corretor.perfil.assinatura_digital|absolute_path }}" class="signature-img">
                        {% else %}
                            <div style="height:50px;"></div>
                        {% endif %}
                    </div>
                    <div class="signature-line">{{ visita.corretor.get_full_name|default:"Corretor" }}</div>
                    <div style="font-size: 8pt;">Corretor (CRECI: {{ visita.corretor.perfil.creci|default:"-" }})</div>
                </td>
            </tr>
        </table>
    </div>

</body>
</html>