<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Relatório Geral de Autorizações</title>
    <style>
        @page {
            size: A4 landscape;
            margin: 1cm;
            margin-bottom: 1.5cm;
        }

        body {
            font-family: Helvetica, sans-serif;
            font-size: 8pt;
            color: #222;
            line-height: 1.3;
        }

        /* CABEÇALHO */
        .header-table {
            width: 100%;
            border-bottom: 2px solid #000;
            padding-bottom: 8px;
            margin-bottom: 15px;
        }
        .company-title { font-size: 14pt; font-weight: bold; text-transform: uppercase; }
        .report-name { font-size: 12pt; font-weight: bold; text-align: right; text-transform: uppercase; }
        .meta-data { font-size: 8pt; text-align: right; color: #555; }

        /* BOX DE RESUMO */
        .summary-box {
            width: 100%;
            background-color: #f4f4f4;
            border: 1px solid #ccc;
            padding: 8px;
            margin-bottom: 15px;
        }
        .summary-table { width: 100%; }
        .sum-label { font-size: 7pt; font-weight: bold; text-transform: uppercase; color: #666; }
        .sum-val { font-size: 10pt; font-weight: bold; color: #000; }
        
        /* TABELA */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        .data-table th {
            background-color: #333;
            color: #fff;
            font-weight: bold;
            font-size: 7pt;
            text-transform: uppercase;
            text-align: left;
            padding: 5px;
            border: 1px solid #333;
        }
        .data-table td {
            border: 1px solid #ddd;
            padding: 4px 5px;
            vertical-align: middle;
            font-size: 7.5pt;
        }
        .data-table tr:nth-child(even) { background-color: #fbfbfb; }

        /* UTILITÁRIOS */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-bold { font-weight: bold; }
        .text-small { font-size: 6.5pt; color: #555; }
        .text-danger { color: #c0392b; font-weight: bold; }
        .text-warning { color: #d35400; font-weight: bold; }
        .text-success { color: #27ae60; font-weight: bold; }
        .bg-alert { background-color: #ffecec; }

        /* RODAPÉ */
        #footer_content {
            position: fixed; bottom: -1cm; left: 0; right: 0; height: 1cm;
            text-align: center; font-size: 7pt; color: #999;
            border-top: 1px solid #ccc; padding-top: 5px;
        }
        .page-number:before { content: counter(page); }
    </style>
</head>
<body>

    <div id="footer_content">
        ImobCloud - Relatório Gerencial - Impresso em {{ data_geracao|date:"d/m/Y H:i" }} por {{ usuario_solicitante|default:"Sistema" }} - Pág. <span class="page-number"></span>
    </div>

    <table class="header-table">
        <tr>
            {% if imobiliaria.logo %}
                <td width="15%" valign="top">
                    <img src="{{ imobiliaria.logo.path }}" style="width: 80px; height: auto;" />
                </td>
                <td width="55%" valign="top">
            {% else %}
                <td width="70%" valign="top">
            {% endif %}
            
                <div class="company-title">
                    {{ imobiliaria.nome_fantasia|default:imobiliaria.nome|default:"IMOBILIÁRIA" }}
                </div>
                <div class="meta-data" style="text-align: left;">
                    {{ imobiliaria.razao_social|default:imobiliaria.nome|default:"-" }} <br>
                    
                    CNPJ: {{ imobiliaria.cnpj|default:"-" }} 
                    {% if imobiliaria.creci %} | CRECI: {{ imobiliaria.creci }} {% endif %}
                    <br>
                    
                    {{ imobiliaria.logradouro|default:"" }} 
                    {% if imobiliaria.numero %}, {{ imobiliaria.numero }}{% endif %}
                    {% if imobiliaria.bairro %} - {{ imobiliaria.bairro }}{% endif %}
                    <br>
                    
                    {{ imobiliaria.cidade|default:"" }} - {{ imobiliaria.estado|default:"" }} <br>
                    
                    {% if imobiliaria.telefone %} Tel: {{ imobiliaria.telefone }} {% endif %}
                    {% if imobiliaria.email %} | Email: {{ imobiliaria.email }} {% endif %}
                </div>
            </td>

            <td width="30%" valign="top" class="text-right">
                <div class="report-name">{{ titulo_relatorio }}</div>
                <div class="meta-data">
                    Gestão de Vigência e Autorizações<br>
                    Ref: {{ data_geracao|date:"F/Y" }}
                </div>
            </td>
        </tr>
    </table>

    <div class="summary-box">
        <table class="summary-table">
            <tr>
                <td width="25%">
                    <div class="sum-label">Imóveis Listados</div>
                    <div class="sum-val">{{ summary.total_imoveis }}</div>
                </td>
                <td width="25%">
                    <div class="sum-label">Venda Potencial</div>
                    <div class="sum-val">{{ summary.total_venda }}</div>
                </td>
                <td width="25%">
                    <div class="sum-label">Aluguel Potencial</div>
                    <div class="sum-val">{{ summary.total_aluguel }}</div>
                </td>
                <td width="25%" style="text-align: right;">
                    <div class="sum-label">Contratos Expirados</div>
                    <div class="sum-val text-danger">{{ summary.total_expirados }}</div>
                </td>
            </tr>
        </table>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th width="5%">Cód.</th>
                <th width="20%">Imóvel</th>
                <th width="12%">Localização</th>
                <th width="15%">Proprietário / Contato</th>
                <th width="6%" class="text-center">Tipo</th>
                <th width="9%" class="text-right">Venda</th>
                <th width="8%" class="text-right">Aluguel</th>
                <th width="5%" class="text-center">Com.</th>
                <th width="4%" class="text-center">Excl.</th>
                <th width="9%" class="text-center">Vigência</th>
                <th width="7%" class="text-center">Situação</th>
            </tr>
        </thead>
        <tbody>
            {% for item in data %}
            <tr class="{% if item.status_risco == 'Expirado' %}bg-alert{% endif %}">
                <td class="text-center text-bold">{{ item.codigo }}</td>
                <td>
                    {{ item.titulo|truncatechars:35 }}<br/>
                    <span class="text-small">{{ item.endereco_resumido|truncatechars:40 }}</span>
                </td>
                <td>{{ item.bairro_cidade }}</td>
                <td>
                    <strong>{{ item.proprietario_nome|truncatechars:20 }}</strong><br/>
                    <span class="text-small">
                        {% if item.proprietario_tel != '-' %}Tel: {{ item.proprietario_tel }}{% endif %}
                    </span>
                </td>
                <td class="text-center">{{ item.finalidade }}</td>
                <td class="text-right">{{ item.valor_venda }}</td>
                <td class="text-right">{{ item.valor_aluguel }}</td>
                <td class="text-center">{{ item.comissao }}</td>
                <td class="text-center">
                    {% if item.exclusividade == 'SIM' %}
                        <strong style="color: #d35400;">SIM</strong>
                    {% else %}NÃO{% endif %}
                </td>
                <td class="text-center">
                    {{ item.data_inicio|date:"d/m/y" }} a<br/>
                    <strong>{{ item.data_fim|date:"d/m/y"|default:"INDET." }}</strong>
                </td>
                <td class="text-center">
                    {% if item.status_risco == 'Expirado' %}
                        <div class="text-danger">VENCIDA</div>
                        <div class="text-small">({{ item.dias_restantes }}d)</div>
                    {% elif item.status_risco == 'Risco (30 dias)' %}
                        <div class="text-warning">VENCE</div>
                        <div class="text-small">({{ item.dias_restantes }}d)</div>
                    {% else %}
                        <div class="text-success">VIGENTE</div>
                    {% endif %}
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="11" class="text-center" style="padding: 30px;">
                    Nenhum imóvel encontrado com os filtros selecionados.
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

</body>
</html>