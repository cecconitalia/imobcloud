<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>{{ titulo_relatorio }}</title>
    <style>
        /* ================= CONFIGURAÇÃO DE PÁGINA E FRAMES ================= */
        @page {
            size: A4 landscape;
            margin: 1.0cm; /* Margens gerais */
            margin-bottom: 2.5cm; /* Espaço reservado na parte inferior para não sobrepor o rodapé */

            /* DEFINIÇÃO DO FRAME DE RODAPÉ (FIXO EM TODAS AS PÁGINAS) */
            @frame footer_frame {
                -pdf-frame-content: footer_content; /* Liga este frame à div com id="footer_content" */
                bottom: 0.5cm;
                left: 1.0cm;
                right: 1.0cm;
                height: 1.0cm;
            }
        }

        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 10px;
            color: #333333;
            line-height: 1.3;
        }

        /* Estilo do Rodapé (Conteúdo do Frame) */
        #footer_content {
            text-align: right;
            font-size: 9px;
            color: #666666;
            border-top: 1px solid #cccccc;
            padding-top: 5px;
        }

        /* ================= CABEÇALHO ================= */
        .header-table {
            width: 100%;
            border-bottom: 2px solid #000000;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .company-name {
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            color: #000000;
        }

        .report-title {
            font-size: 18px;
            font-weight: bold;
            text-transform: uppercase;
            color: #333333;
            margin-top: 5px;
        }

        .report-meta {
            font-size: 9px;
            color: #555555;
            text-align: right;
            vertical-align: bottom;
        }

        /* ================= SUMÁRIO (DASHBOARD) ================= */
        .summary-box {
            width: 100%;
            border: 1px solid #dddddd;
            background-color: #f9f9f9;
            margin-bottom: 20px;
        }
        
        .summary-box td {
            padding: 10px 15px;
            width: 33.33%;
            border-right: 1px solid #dddddd;
            vertical-align: top;
        }
        .summary-box td:last-child {
            border-right: none;
        }

        .sum-label {
            font-size: 8px;
            text-transform: uppercase;
            color: #888888;
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .sum-value {
            font-size: 14px;
            font-weight: bold;
            color: #000000;
            display: block;
            white-space: nowrap;
        }
        .text-danger { color: #cc0000; }
        .text-primary { color: #0056b3; }

        /* ================= TABELA DE DADOS ================= */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background-color: #eeeeee;
            color: #000000;
            font-weight: bold;
            font-size: 9px;
            text-transform: uppercase;
            padding: 8px 5px;
            border-top: 1px solid #000000;
            border-bottom: 1px solid #000000;
            text-align: left;
        }

        .data-table td {
            padding: 6px 5px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 9px;
            vertical-align: middle;
        }

        .data-table tr:nth-child(even) {
            background-color: #fdfdfd;
        }

        /* ================= CLASSES UTILITÁRIAS ================= */
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .bold { font-weight: bold; }
        
        /* Larguras das Colunas */
        .col-ref      { width: 6%; }
        .col-imovel   { width: 24%; }
        .col-tipo     { width: 8%; }
        .col-prop     { width: 15%; }
        .col-cidade   { width: 9%; }
        .col-captacao { width: 7%; }
        .col-valor    { width: 11%; }
        .col-comissao { width: 6%; }
        .col-exc      { width: 4%; }
        .col-vencto   { width: 10%; }
        
        /* Status Colors */
        .st-expired { color: #cc0000; font-weight: bold; }
        .st-risk    { color: #e69500; font-weight: bold; }
        .st-ok      { color: #000000; }

    </style>
</head>
<body>

    <div id="footer_content">
        Relatório Gerado por ImobCloud - {{ imobiliaria.nome|default:"Estilo Musical" }} &nbsp;|&nbsp; Pág. <pdf:pagenumber/>
    </div>

    <table class="header-table">
        <tr>
            <td width="50%" valign="top">
                {% if imobiliaria.logo %}
                    <img src="{{ imobiliaria.logo.path }}" style="height: 45px; margin-bottom: 5px;">
                {% endif %}
                <div class="company-name">{{ imobiliaria.nome|default:"Estilo Musical" }}</div>
                <div class="report-title">Relatório de Autorizações</div>
            </td>
            <td width="50%" valign="bottom" class="report-meta">
                <strong>Filtro:</strong> {{ titulo_relatorio|slice:"26:"|default:"Todos" }}<br>
                <strong>Emissão:</strong> {{ data_geracao|date:"d/m/Y" }}<br>
                <strong>Registros:</strong> {{ data|length }}
            </td>
        </tr>
    </table>

    <table class="summary-box" cellspacing="0" cellpadding="0">
        <tr>
            <td>
                <span class="sum-label">Total de Imóveis</span>
                <span class="sum-value text-primary">{{ summary.total_imoveis }}</span>
            </td>
            <td>
                <span class="sum-label">Contratos em Risco/Vencidos</span>
                <span class="sum-value text-danger">{{ summary.total_expirados }}</span>
            </td>
            <td>
                <span class="sum-label">Valor Total da Carteira</span>
                <span class="sum-value">{{ summary.total_valor_geral }}</span>
            </td>
        </tr>
    </table>

    {% if data %}
    <table class="data-table">
        <thead>
            <tr>
                <th class="col-ref">Ref.</th>
                <th class="col-imovel">Imóvel</th>
                <th class="col-tipo">Tipo</th>
                <th class="col-prop">Proprietário</th>
                <th class="col-cidade">Cidade</th>
                <th class="col-captacao">Captação</th>
                <th class="col-valor text-right">Valor</th>
                <th class="col-comissao text-right">Com(%)</th>
                <th class="col-exc text-center">Exc.</th>
                <th class="col-vencto text-center">Vencimento</th>
            </tr>
        </thead>
        <tbody>
            {% for item in data %}
            <tr>
                <td>{{ item.codigo_referencia }}</td>
                <td>
                    <strong>{{ item.titulo_anuncio|truncatechars:35 }}</strong>
                    {% if item.status_risco != 'Ativo' %}
                        <br>
                        <span style="font-size: 8px;" class="
                            {% if item.status_risco == 'Expirado' %}st-expired{% endif %}
                            {% if item.status_risco == 'Risco (30 dias)' %}st-risk{% endif %}
                            {% if item.status_risco == 'Atenção (90 dias)' %}text-primary{% endif %}
                        ">
                            ALERTA: {{ item.status_risco|upper }}
                        </span>
                    {% endif %}
                </td>
                <td>{{ item.tipo_imovel|default:"-"|slice:":12" }}</td>
                <td>{{ item.proprietario|truncatechars:20 }}</td>
                <td>{{ item.cidade|default:"-" }}</td>
                <td>{% if item.data_captacao %}{{ item.data_captacao|date:"d/m/Y" }}{% else %}-{% endif %}</td>
                <td class="text-right bold">{{ item.valor_formatado }}</td>
                <td class="text-right">{{ item.comissao|floatformat:1 }}%</td>
                <td class="text-center">{{ item.exclusividade|slice:":1" }}</td>
                <td class="text-center">
                    {% if item.data_fim_autorizacao %}
                        {{ item.data_fim_autorizacao|date:"d/m/Y" }}<br>
                        <span style="font-size: 8px; color: #666;">
                            {% if item.dias_restantes < 0 %}
                                (Vencido)
                            {% else %}
                                ({{ item.dias_restantes }} dias)
                            {% endif %}
                        </span>
                    {% else %}
                        -
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div style="text-align: center; padding: 30px; border: 1px dashed #ccc; color: #777; margin-top: 20px;">
        Nenhum registro encontrado para os filtros selecionados.
    </div>
    {% endif %}

</body>
</html>